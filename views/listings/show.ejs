<% layout("/layouts/boilerplate")%>
<script>
  const mapToken="<%=process.env.MAP_TOKEN%>";
  const listing=<%-JSON.stringify(listing)%>;
</script>

<style>
  .show-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 40px;
  }
  .show-title {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #222222;
  }
  .show-subtitle {
    font-size: 14px;
    color: #717171;
    margin-bottom: 24px;
  }
  .show-image {
    width: 100%;
    height: 480px;
    object-fit: cover;
    border-radius: 16px;
    margin-bottom: 32px;
  }
  .detail-section {
    padding: 32px 0;
    border-bottom: 1px solid #ebebeb;
  }
  .detail-section:last-of-type {
    border-bottom: none;
  }
  .section-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #222222;
  }
  .owner-badge {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background-color: #f7f7f7;
    border-radius: 24px;
    font-size: 14px;
    color: #222222;
    margin-bottom: 16px;
  }
  .price-box {
    border: 1px solid #dddddd;
    border-radius: 12px;
    padding: 24px;
    background-color: white;
    box-shadow: 0 2px 16px rgba(0,0,0,0.12);
    position: sticky;
    top: 100px;
  }
  .price-amount {
    font-size: 22px;
    font-weight: 600;
    color: #222222;
  }
  .review-card {
    border: 1px solid #ebebeb;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
  }
</style>

<div class="show-container">
    <h1 class="show-title"><%=listing.title%></h1>
    <p class="show-subtitle">
      <i class="fa-solid fa-location-dot"></i> <%=listing.location%>, <%=listing.country%>
    </p>
    
    <img
      src="<%=listing.image.url%>"
      class="show-image"
      alt="<%=listing.title%>"
    />

    <div class="row">
      <div class="col-lg-7">
        <div class="detail-section">
          <div class="owner-badge">
            <i class="fa-solid fa-user" style="margin-right: 8px;"></i>
            Hosted by <%= listing.owner ? listing.owner.username : 'Unknown' %>
          </div>
          <p style="font-size: 16px; line-height: 1.6; color: #222222;">
            <%=listing.description%>
          </p>
        </div>

        <div class="detail-section">
          <h3 class="section-title">Where you'll be</h3>
          <p style="color: #717171; margin-bottom: 16px;"><%=listing.location%>, <%=listing.country%></p>
          <div id="map"></div>
        </div>

        <%if(currentUser && listing.owner && currentUser._id.equals(listing.owner._id)){ %>
        <div class="detail-section">
          <div class="d-flex gap-2">
            <a href="/listings/<%=listing._id%>/edit" class="btn edit-btn" style="flex: 1;">
              <i class="fa-solid fa-pen-to-square"></i> Edit Listing
            </a>
            <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE" style="flex: 1;">
              <button class="btn btn-dark w-100">
                <i class="fa-solid fa-trash"></i> Delete
              </button>
            </form>
          </div>
        </div>
        <%}%>

        <div class="detail-section">
     
        <% if(currentUser){ %>
        <h3 class="section-title">Leave a Review</h3>
        <form
          action="/listings/<%=listing.id%>/reviews"
          method="POST"
          novalidate
          class="needs-validation"
        >
        
        <div class="mb-3 mt-3">
          <label
            for="rating"
            class="form-label"
            >Rating</label
          >
        <fieldset class="starability-slot">
          
          
          <input
            type="radio"
            id="no-rate"
            class="input-no-rate"
            name="review[rating]"
            value="1"
            checked
            aria-label="No rating."
          />
          <input
            type="radio"
            id="first-rate1"
            name="review[rating]"
            value="1"
          />
          <label
            for="first-rate1"
            title="Terrible"
            >1 star</label
          >
          <input
            type="radio"
            id="first-rate2"
            name="review[rating]"
            value="2"
          />
          <label
            for="first-rate2"
            title="Not good"
            >2 stars</label
          >
          <input
            type="radio"
            id="first-rate3"
            name="review[rating]"
            value="3"
          />
          <label
            for="first-rate3"
            title="Average"
            >3 stars</label
          >
          <input
            type="radio"
            id="first-rate4"
            name="review[rating]"
            value="4"
          />
          <label
            for="first-rate4"
            title="Very good"
            >4 stars</label
          >
          <input
            type="radio"
            id="first-rate5"
            name="review[rating]"
            value="5"
          />
          <label
            for="first-rate5"
            title="Amazing"
            >5 stars</label
          >
        </fieldset>
        </div>
        <div class="mb-3 mt-3">
          <label
            for="comment"
            class="form-label"
            >Comments</label
          >
          <textarea
            name="review[comment]"
            id="comment"
            cols="30"
            rows="5"
            class="form-control"
            required
          ></textarea>
          <div class="invalid-feedback">
            Please add some comments for review.
          </div>
        </div>
          <button class="btn btn-dark" style="background-color: #222222; border: none; padding: 12px 24px; border-radius: 8px;">
            Submit Review
          </button>
        </form>
        <%}%>

        <% if(listing.reviews.length > 0){ %>
        <div style="margin-top: 32px;">
          <h3 class="section-title">Reviews</h3>
          <% for(review of listing.reviews){%>
          <div class="review-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <h6 style="font-weight: 600; margin-bottom: 4px;">@<%=review.author.username%></h6>
                <p class="starability-result" data-rating=<%=review.rating%> style="margin-bottom: 8px;"></p>
              </div>
              <form method="POST" action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE">
                <button class="btn btn-sm" style="color: #717171;">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>
            </div>
            <p style="color: #222222; line-height: 1.5; margin: 0;"><%=review.comment%></p>
          </div>
          <% } %>
        </div>
        <% } %>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="price-box">
          <p class="price-amount">
            &#8377;<%=listing.price.toLocaleString("en-IN")%>
            <span style="font-size: 16px; font-weight: 400; color: #717171;">/ night</span>
          </p>
          <hr style="margin: 20px 0;">
          <div style="margin-bottom: 12px;">
            <i class="fa-solid fa-location-dot" style="color: #717171; margin-right: 8px;"></i>
            <span style="color: #222222;"><%=listing.location%>, <%=listing.country%></span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="/js/map.js"></script>
